# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: 3

silent: true

tasks:
  connectivity:test:
    desc: "Test SSH connectivity"
    vars:
      HOST_IP:
        sh: cd 1-terraform/environment/{{.STAGE}} && terraform output -raw vm_public_ipv4
      DEBUG: '{{default "false" .DEBUG}}'
      DRY_RUN: '{{default "false" .DRY_RUN}}'
      COMMAND: |
        ssh \
          -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          -i ~/.ssh/id_rsa \
          -p 22 ubuntu@{{.HOST_IP}} \
          "date"
    cmds:
      - |
        echo ""
        echo "ðŸš€ {{.TASK}} ($(pwd))"
        echo "     STAGE: {{.STAGE}}"
        echo "     HOST_IP: {{.HOST_IP}}"
        echo ""

        if [ "{{.DEBUG}}" == "true" ]; then
          echo "     COMMAND: {{.COMMAND}}"
        fi

        if [ "{{.DRY_RUN}}" == "true" ]; then
          echo "     Skipping command execution due to DRY_RUN."
        else
          {{.COMMAND}}
        fi
    requires:
      vars: [STAGE]

  connect:
    desc: "SSH connect"
    vars:
      HOST_IP:
        sh: cd 1-terraform/environment/{{.STAGE}} && terraform output -raw vm_public_ipv4
      DEBUG: '{{default "false" .DEBUG}}'
      DRY_RUN: '{{default "false" .DRY_RUN}}'
      COMMAND: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
          -i ~/.ssh/id_rsa \
          -p 22 \
          ubuntu@{{.HOST_IP}}
    cmds:
      - |
        echo ""
        echo "ðŸš€ {{.TAKS}} ($(pwd))"
        echo "     STAGE: {{.STAGE}}"
        echo "     HOST_IP: {{.HOST_IP}}"
        echo ""

        if [ "{{.DEBUG}}" == "true" ]; then
          echo "     COMMAND: {{.COMMAND}}"
        fi

        if [ "{{.DRY_RUN}}" == "true" ]; then
          echo "     Skipping command execution due to DRY_RUN."
        else
          {{.COMMAND}}
        fi
    requires:
      vars: [STAGE]
