version: 3

silent: true

tasks:
  # ===============
  # === ANSIBLE ===
  # ===============
  inventory:print:
    dir: "{{.USER_WORKING_DIR}}/2-ansible"
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - inventory:print [ STAGE - {{.STAGE}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible-inventory -i inventory/hosts_{{.STAGE}}.yml --graph --vars
    requires:
      vars: [STAGE]

  test:connectivity:
    dir: "{{.PLAYBOOK_PATH}}"
    vars:
      PLAYBOOK_PATH: '{{default "path" .PLAYBOOK_PATH}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - test:connectivity [ STAGE - {{.STAGE}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible -i inventory/hosts_{{.STAGE}}.yml -m ping all
    requires:
      vars: [STAGE]

  playbook:site:
    # dir: "{{.USER_WORKING_DIR}}/2-ansible"
    vars:
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}} ]"
      - pwd
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}}
    requires:
      vars: [STAGE]

  playbook:site:vars:
    dir: "{{.USER_WORKING_DIR}}/2-ansible"
    vars:
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site:vars [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}}, VARIABLES - {{.VARIABLES}} ]"
      - pwd
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}} -e "{{ .VARIABLES }}"
    requires:
      vars: [STAGE, VARIABLES]

  playbook:site:vars:tags:
    dir: "{{.USER_WORKING_DIR}}/2-ansible"
    vars:
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site:vars:tags [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}}, VARIABLES - {{.VARIABLES}}, TAGS - {{.TAGS}} ]"
      - pwd
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}} -e "{{ .VARIABLES }}" --tags "{{ .TAGS }}"
    requires:
      vars: [STAGE, VARIABLES, TAGS]
