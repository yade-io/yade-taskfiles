version: 3

silent: true

tasks:
  # ===============
  # === ANSIBLE ===
  # ===============
  install:requirements:
    desc: "Install ansible requirements"
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "ansible" .ANSIBLE_DIR}}'
      ANSIBLE_GALAXY_PATH: '{{default "../.venv/bin/ansible-galaxy" .ANSIBLE_GALAXY_PATH}}'
    cmds:
      - echo ""
      - echo "ðŸš€ create:venv [ VENV_DIR - {{.VENV_DIR}}"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - "{{.ANSIBLE_GALAXY_PATH}} install -r requirements.yml --force"

  test:connectivity:
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "." .ANSIBLE_DIR}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - test:connectivity [ STAGE - {{.STAGE}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible -i inventory/hosts_{{.STAGE}}.yml -m ping all
    requires:
      vars: [STAGE]

  inventory:print:
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "." .ANSIBLE_DIR}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - inventory:print [ STAGE - {{.STAGE}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible-inventory -i inventory/hosts_{{.STAGE}}.yml --graph --vars
    requires:
      vars: [STAGE]

  playbook:site:
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "." .ANSIBLE_DIR}}'
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}}
    requires:
      vars: [STAGE]

  playbook:site:vars:
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "." .ANSIBLE_DIR}}'
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site:vars [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}}, VARIABLES - {{.VARIABLES}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}} -e "{{ .VARIABLES }}"
    requires:
      vars: [STAGE, VARIABLES]

  playbook:site:vars:tags:
    dir: "{{.ANSIBLE_DIR}}"
    vars:
      ANSIBLE_DIR: '{{default "." .ANSIBLE_DIR}}'
      PLAYBOOK: '{{default "site.yml" .PLAYBOOK}}'
    cmds:
      - echo ""
      - echo "ðŸš€ tasks-ansible - playbook:site:vars:tags [ STAGE - {{.STAGE}}, PLAYBOOK - {{.PLAYBOOK}}, VARIABLES - {{.VARIABLES}}, TAGS - {{.TAGS}} ]"
      - 'echo "   cwd: $(pwd)"'
      - echo ""
      - ansible-playbook -i inventory/hosts_{{.STAGE}}.yml {{.PLAYBOOK}} -e "{{ .VARIABLES }}" --tags "{{ .TAGS }}"
    requires:
      vars: [STAGE, VARIABLES, TAGS]
